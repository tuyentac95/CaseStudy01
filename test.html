<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test New</title>
    <style>
        body {
            background-image: url("Background_undersea_02.jpg");
        }
    </style>
</head>
<body onload="docReady()">
<canvas id="myCanvas" width="1300" height="600" style="border: 1px solid #c3c3c3;alignment: center"></canvas>
<img id="mainCharacter" src="" style="position: absolute;left: 50px; top: 200px;">
<img id="enemyBoss" src="" style="position: absolute;left: 1000px; top: 200px;">
<p>
    <input type="button" value="Start Game" onclick="startGame();">
    <input type="button" value="Start Game PvP" onclick="startGamePvP();">
</p>
<script>
    function startGamePvP() {
        window.addEventListener('keydown', moveSelectionP2);

        gyarados.setSourceImage('Gyarados_right_move.gif');
        gyarados.setHP(200);
        gyarados.setHPPosition(20, 580);
        gyarados.setEnergy(50);

        lapras.setSourceImage('Lapras_left_move.gif');
        lapras.setHP(200);
        lapras.setHPPosition(1230, 580);
        lapras.setEnergy(50)

        createRazz();
        razz_array[razz_array.length-1].appear();

        let CreateRazz = setInterval(function () {
            createRazz();
            razz_array[razz_array.length-1].appear();
        }, 4200);

        let CheckRazz = setInterval(function () {
            for (let i=0; i < razz_array.length; i++) {
                console.log(razz_array[i].status)
                if (razz_array[i].status !== 'eaten') {
                    razz_array[i].appear();
                    razz_array[i].berryEaten(gyarados);
                    razz_array[i].berryEaten(lapras);
                }
            }
        },5)

        let TimeId = setInterval(function () {
            gyarados.drawHPBar();
            gyarados.drawEnergyBar();
            lapras.drawHPBar();
            lapras.drawEnergyBar();
            if (gyarados.isKnocked()) {
                alert('Lapras Win');
                clearInterval(CreateRazz);
                clearInterval(CheckRazz);
                clearInterval(TimeId);
            } else if (lapras.isKnocked()) {
                alert('Gyarados Win');
                clearInterval(CreateRazz);
                clearInterval(CheckRazz);
                clearInterval(TimeId);
            }
        },5);
    }

    function startGame() {
        gyarados.setSourceImage('Gyarados_right_move.gif');
        gyarados.setHP(100);
        gyarados.setHPPosition(20, 580);
        gyarados.setEnergy(50);

        lapras.setSourceImage('Lapras_left_move.gif');
        lapras.setHP(200);
        lapras.setHPPosition(1260, 580);

        createRazz();
        razz_array[razz_array.length-1].appear();

        let time = 0;
        let LaprasMovement = setInterval(function () {
            if (time < 100) {
                lapras.goUp(2);
                time++;
            }
            if ((time < 400) && (time >= 100)) {
                lapras.goLeft(3);
                time++;
            }
            if ((time >= 400) && (time < 800)) {
                lapras.goRight(0);
                lapras.goDown(2);
                time++;
            }
            if ((time >= 800) && (time < 1100)) {
                lapras.goRight(3);
                time++;
            }
            if ((time >= 1100) && (time < 1400)) {
                lapras.goLeft(0);
                lapras.goUp(2);
                time++;
            }
            if (time >= 1400) {
                time = 0;
            }
        }, 50);

        let LaprasAttack = setInterval(function () {
            lapras.roar();
            createEnemyBullet();
            lapras_bullet_array[lapras_bullet_array.length-1].shoot();
        },3000);

        let CreateRazz = setInterval(function () {
            createRazz();
            razz_array[razz_array.length-1].appear();
        }, 5000);

        let CheckRazz = setInterval(function () {
            for (let i=0; i < razz_array.length; i++) {
                console.log(razz_array[i].status)
                if (razz_array[i].status !== 'eaten') {
                    razz_array[i].appear();
                    razz_array[i].berryEaten(gyarados);
                }
            }
        },5)

        let TimeId = setInterval(function () {
            gyarados.drawHPBar();
            gyarados.drawEnergyBar();
            lapras.drawHPBar();
            if (gyarados.isKnocked()) {
                alert('Game Over');
                clearInterval(LaprasMovement);
                clearInterval(LaprasAttack);
                clearInterval(CreateRazz);
                clearInterval(CheckRazz);
                clearInterval(TimeId);
            } else if (lapras.isKnocked()) {
                alert('You Win');
                clearInterval(LaprasMovement);
                clearInterval(LaprasAttack);
                clearInterval(CreateRazz);
                clearInterval(CheckRazz);
                clearInterval(TimeId);
            }
        },5);
    }
    function rightArrowPressed() {
        gyarados.goRight(20);
    }
    function leftArrowPressed() {
        gyarados.goLeft(20);
    }
    function upArrowPressed() {
        gyarados.goUp(20);
    }
    function downArrowPressed() {
        gyarados.goDown(20);
    }
    function pPressed() {
        gyarados.roar();
        if (gyarados.getEnergy() > 0) {
            createBullet();
            gyarados_bullet_array[gyarados_bullet_array.length-1].shoot();
            gyarados.decreaseEnergy();
        }
    }
    function dPressed() {
        lapras.goRight(20);
    }
    function aPressed() {
        lapras.goLeft(20);
    }
    function wPressed() {
        lapras.goUp(20);
    }
    function sPressed() {
        lapras.goDown(20);
    }
    function hPressed() {
        lapras.roar();
        if (lapras.getEnergy() > 0) {
            createEnemyBullet();
            lapras_bullet_array[lapras_bullet_array.length-1].shoot();
            lapras.decreaseEnergy();
            console.log(lapras.getEnergy())
        }
    }
    function moveSelection(evt) {
        switch (evt.keyCode) {
            case 37:
                leftArrowPressed();
                break;
            case 38:
                upArrowPressed();
                break;
            case 39:
                rightArrowPressed();
                break;
            case 40:
                downArrowPressed();
                break;
            case 80:
                pPressed();
                break;
        }
    }
    function moveSelectionP2(evt) {
        switch (evt.keyCode) {
            case 65:
                aPressed();
                break;
            case 87:
                wPressed();
                break;
            case 68:
                dPressed();
                break;
            case 83:
                sPressed();
                break;
            case 72:
                hPressed();
                break;
        }
    }
    function docReady() {
        window.addEventListener('keydown', moveSelection);

    }
    let Character = function (id,srcGoRight,srcGoLeft,srcRoarRight,srcRoarLeft) {
        let _thisRef = this;
        this.character = document.getElementById(id);
        this.x = parseInt(this.character.style.left);
        this.y = parseInt(this.character.style.top);
        this.setHP = function (HP) {
            this.HP = HP;
            this.maxHP = HP;
        }
        this.getHP = function () {
            return this.HP;
        }
        this.decreaseHP = function () {
            if (this.getHP() > 0) {
                this.HP -= 10;
                this.drawHPBar();
            }
        }
        this.isKnocked = function () {
            if (this.getHP() > 0) {
                return false;
            } else return true;
        }
        this.setHPPosition = function (x, y) {
            this.HPPositionX = x;
            this.HPPositionY = y;
        }
        this.drawHPBar = function () {
            ctx.clearRect(this.HPPositionX, this.HPPositionY,20,-2.5*(this.getHP()+10));
            if (this.HP < 0.5*this.maxHP) {
                ctx.fillStyle = 'red';
            } else {ctx.fillStyle = 'green';}
            ctx.fillRect(this.HPPositionX, this.HPPositionY,20,-2.5*this.getHP());
        }
        this.setEnergy = function (energy) {
            this.energy = energy;
        }
        this.getEnergy = function () {
            return this.energy;
        }
        this.increaseEnergy = function () {
            if (this.getEnergy() < 100) {
                this.energy += 10;
                this.drawEnergyBar();
            }
        }
        this.decreaseEnergy = function () {
            if (this.getEnergy() > 0) {
                this.energy -= 10;
                this.drawEnergyBar();
            }
        }
        this.drawEnergyBar = function () {
            this.EnergyPositionX = this.HPPositionX + 30;
            this.EnergyPositionY = this.HPPositionY;
            ctx.clearRect(this.EnergyPositionX, this.EnergyPositionY, 20, -2.5*(this.energy + 10));
            ctx.fillStyle = 'yellow';
            ctx.fillRect(this.EnergyPositionX, this.EnergyPositionY, 20, -2.5*this.energy);
        }
        this.getLeft = function () {
            return parseInt(this.character.style.left);
        }
        this.getTop = function () {
            return parseInt(this.character.style.top);
        }
        this.setSourceImage = function (src) {
            this.character.src = src;
        }
        this.directionX = function () {
            if (this.character.src.match('right')) {
                return 'right';
            } else return 'left';
        }
        this.getWidth = function () {
            return this.character.width;
        }
        this.getHeight = function () {
            return this.character.height;
        }
        this.setLeft = function () {
            this.character.style.left = this.x + 'px';
        }
        this.setTop = function () {
            this.character.style.top = this.y + 'px';
        }
        this.goRight = function (value) {
            if (this.directionX() === 'left') {
                this.character.src = srcGoRight;
            }
            if (this.x + this.getWidth() < canvas.width) {
                this.x += value;
                this.setLeft();
            }
        }
        this.goLeft = function (value) {
            if (this.directionX() === 'right') {
                this.character.src = srcGoLeft;
            }
            if (this.x > 0) {
                this.x -= value;
                this.setLeft();
            }
        }
        this.goUp = function (value) {
            if (this.y > 0) {
                this.y -= value;
                this.setTop();
            }
        }
        this.goDown = function (value) {
            if (this.y + this.getHeight() < canvas.height) {
                this.y += value;
                this.setTop();
            }
        }
        this.roar = function () {
            if (this.directionX() === 'right') {
                this.character.src = srcRoarRight;
                setTimeout(function () {
                    _thisRef.character.src = srcGoRight;
                },1500)
            } else {
                this.character.src = srcRoarLeft;
                setTimeout(function () {
                    _thisRef.character.src = srcGoLeft;
                }, 1500);
            }
        }
    }
    let Berry = function(object,srcImage) {
        this.image = object;
        this.image.src = srcImage;
        this.status = '';
        this.x = Math.floor(Math.random()*(canvas.width -200)) + 100;
        this.y = Math.floor(Math.random()*(canvas.height -200)) + 100;
        this.getLeft = function () {
            return this.x;
        }
        this.getTop = function () {
            return this.y;
        }
        this.appear = function () {
            ctx.drawImage(this.image, this.x, this.y, 50, 50);
        }
        this.disappear = function () {
            ctx.clearRect(this.x, this.y, 50, 50);
        }
        this.isEaten = function (eater) {
            return (eater.getLeft() + 20 <= this.getLeft()) && (eater.getLeft() + eater.getWidth() >= this.getLeft() + 50)
                && (eater.getTop() + 20 <= this.getTop()) && (eater.getTop() + eater.getHeight() >= this.getTop() + 50);
        }
        this.setStatus = function (status) {
            this.status = status;
        }
        this.berryEaten = function (eater) {
            if (this.isEaten(eater)) {
                this.disappear();
                this.setStatus('eaten');
                eater.increaseEnergy();
            }
        }
    }
    let Bullet = function(object,shooter,enemy,srcGoRight,srcGoLeft) {
        let _thisRef = this;
        this.shooter = shooter;
        this.image = object;
        this.enemy = enemy;
        this.shoot = function () {
            if (this.shooter.directionX() === 'right') {
                this.image.src = srcGoRight;
                this.x = this.shooter.getLeft()+140;
                this.y = this.shooter.getTop()+85;
                setTimeout(function () {
                    ctx.drawImage(_thisRef.image, _thisRef.x, _thisRef.y, 84, 58);
                    let timerId = setInterval(function () {
                        ctx.clearRect(_thisRef.x, _thisRef.y, 84, 58);
                        _thisRef.x += 35;
                        if (_thisRef.isHit()) {_thisRef.enemy.decreaseHP();}
                        if ((_thisRef.isHit()) || (_thisRef.x > canvas.width)){
                            ctx.clearRect(_thisRef.x, _thisRef.y, 84, 58);
                            clearInterval(timerId);
                        } else {
                            ctx.drawImage(_thisRef.image, _thisRef.x, _thisRef.y, 84, 58);
                        }
                    }, 50)
                }, 680)
            } else {
                this.image.src = srcGoLeft;
                this.x = this.shooter.getLeft()-50;
                this.y = this.shooter.getTop()+85;
                setTimeout(function () {
                    ctx.drawImage(_thisRef.image, _thisRef.x, _thisRef.y, 84, 58);
                    let timerId = setInterval(function () {
                        ctx.clearRect(_thisRef.x, _thisRef.y, 84, 58);
                        _thisRef.x -= 35;
                        if (_thisRef.isHit()) {_thisRef.enemy.decreaseHP();}
                        if ((_thisRef.isHit()) || (_thisRef.x < 0)) {
                            ctx.clearRect(_thisRef.x, _thisRef.y, 84, 58);
                            clearInterval(timerId);
                        } else {
                            ctx.drawImage(_thisRef.image, _thisRef.x, _thisRef.y, 84, 58);
                        }
                    }, 50)
                }, 680)
            }
        }
        this.isHit = function () {
            if (((this.enemy.getLeft() + 60) < (this.x + this.image.width))
                && ((this.enemy.getLeft() + 120) > (this.x + this.image.width))
                && ((this.enemy.getTop() + 90) < (this.y + this.image.height))
                && ((this.enemy.getTop() + 180) > (this.y + this.image.height)))
            {
                return true;
            }
        }
    }

    let canvas = document.getElementById('myCanvas');
    let ctx = canvas.getContext('2d');

    let gyarados = new Character('mainCharacter','Gyarados_right_move.gif','Gyarados_left_move.gif','Gyarados_right_roar.gif','Gyarados_left_roar.gif');
    let gyarados_bullet_array = [];
    let gyarados_bullet_image = new Image();
    function createBullet() {
        gyarados_bullet_array[gyarados_bullet_array.length] = new Bullet(gyarados_bullet_image,gyarados,lapras,'Energy_ball_1_right.png','Energy_ball_1_left.png');
    }

    let lapras = new Character('enemyBoss','Lapras_right_move.gif','Lapras_left_move.gif','Lapras_right_roar.gif','Lapras_left_roar.gif');
    let lapras_bullet_array = [];
    let lapras_bullet_image = new Image();
    function createEnemyBullet() {
        lapras_bullet_array[lapras_bullet_array.length] = new Bullet(lapras_bullet_image,lapras,gyarados,'Ice_ball_1_right.png','Ice_ball_1_left.png');
    }

    let razz_array = [];
    let razz_image = new Image()
    function createRazz() {
        razz_array[razz_array.length] = new Berry(razz_image, 'Berry_Razz.png');
    }

</script>
</body>
</html>